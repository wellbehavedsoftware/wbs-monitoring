#!/bin/bash

set -euf -o pipefail

version="$1"

targets=(
	"trusty"
	"xenial"
)

function header () {
	echo "" >&2
	echo "#################### $1" >&2
	echo "" >&2
}

# ---------- check the version number

if test -f ".git/refs/tags/$version"; then

	header "Sanity check failed"

	echo "Version $version already exists"
	echo "Build aborted"

	echo ""

	false

fi

# ---------- update the version number

header "Preparing for build"

echo "Updating version number in Cargo.toml"

sed_script="/tmp/sed-script-$$"

cat >"$sed_script" <<-END
	/^\[package\]$/, /^\[/ {
		s/version = ".*"/version = "$version\"/
	}
END

sed --in-place \
	--regexp-extended \
	--file "$sed_script" \
	"Cargo.toml"

rm "$sed_script"

# ---------- create the archive to build

echo "Cleaning build"

( cd libaptc; make clean )
cargo clean

echo "Creating source archive"

project_source="wbs-monitoring-$version"

mkdir -p "dist"

rsync \
	--archive \
	--delete \
	--delete-excluded \
	--exclude "/.git" \
	--exclude "/dist" \
	--exclude "/target" \
	"./" \
	"dist/$project_source/"

tar --create --xz \
	--file "dist/$project_source.tar.xz" \
	--directory "dist" \
	"$project_source"

# ---------- iterate targets

for target in "${targets[@]}"; do

	header "Building for $target"

	project_target="$project_source-$target"

	# ---------- sync to target

	lxc file push \
		"dist/$project_source.tar.xz" \
		"build-$target/root/$project_source.tar.xz"

	lxc exec "build-$target" -- \
		rm -rf "$project_source"

	lxc exec "build-$target" -- \
		tar --extract --xz --file "$project_source.tar.xz"

	# ---------- build and retrieve

	lxc exec "build-$target" -- \
		"$project_source/scripts/build-package" \
		"$version" \
		"$target"

	lxc file pull \
		"build-$target/root/$project_source/dist/$project_target.tar.xz" \
		"dist/$project_target.tar.xz"

done

# ---------- git commit

header "Finalising"

echo "Committing changes to git"

git reset "HEAD"
git add "Cargo.toml" "Cargo.lock"
git commit --message "release $version"
git stash --include-untracked

# ---------- upload to server

echo "Uploading $project_source.tar.xz to dist"

scp \
	"dist/$project_source.tar.xz" \
	"dist:dist/wbs-monitoring/"

for target in "${targets[@]}"; do

	echo "Uploading $project_source-target.tar.xz to dist"

	scp \
		"dist/$project_source-$target.tar.xz" \
		"dist:dist/wbs-monitoring/"

done

# ---------- create tag

echo "Pushing changes to git"

git tag "$version"
git push origin master --tags

header "Build complete"

# ex: noet ts=4 filetype=sh
